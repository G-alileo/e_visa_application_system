{% extends "base/base.html" %}
{% block title %}Upload Documents — E-Visa Portal{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 py-8 space-y-6">

  <!-- Breadcrumb -->
  <nav class="text-sm text-slate-500 flex items-center gap-1">
    <a href="{% url 'applications:dashboard' %}" class="hover:text-primary transition-colors">My Applications</a>
    <span class="material-symbols-outlined text-[16px]">chevron_right</span>
    <a href="{% url 'applications:status' pk=application.pk %}" class="hover:text-primary transition-colors">
      {{ application.visa_type.name }}
    </a>
    <span class="material-symbols-outlined text-[16px]">chevron_right</span>
    <span class="font-medium" style="color:var(--text)">Documents</span>
  </nav>

  <!-- Application header -->
  <div class="glass-card p-5 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
    <div>
      <h1 class="text-xl font-black" style="color:var(--text)">Upload Documents</h1>
      <p class="text-xs text-slate-500 mt-1">
        {{ application.visa_type.name }} &mdash;
        <span class="status-pill s-{{ application.status }}">{{ application.get_status_display }}</span>
      </p>
    </div>
    <div class="flex items-center gap-2">
      <a href="{% url 'applications:recommendations' pk=application.pk %}" class="btn-secondary text-xs py-2 px-3">
        <span class="material-symbols-outlined text-[16px]">lightbulb</span>
        Recommendations
      </a>
      {% if can_submit %}
      <form method="post" action="{% url 'applications:submit' pk=application.pk %}">
        {% csrf_token %}
        <button type="submit" class="btn-primary text-xs py-2 px-3"
          onclick="return confirm('Submit this application? You cannot make changes after submission.')">
          <span class="material-symbols-outlined text-[16px]">send</span>
          Submit Application
        </button>
      </form>
      {% endif %}
    </div>
  </div>

  <!-- Document checklist -->
  <div class="glass-card p-6">
    <h2 class="font-bold mb-4 flex items-center gap-2" style="color:var(--text)">
      <span class="material-symbols-outlined text-primary text-[20px]">checklist</span>
      Required Documents
      {% if doc_summary.all_uploaded %}
      <span class="status-pill s-APPROVED ml-2">
        <span class="material-symbols-outlined text-[12px]">check</span> All uploaded
      </span>
      {% endif %}
    </h2>

    {% if doc_summary.summary %}
    <div class="space-y-2 mb-6">
      {% for item in doc_summary.summary %}
      <div class="flex items-center justify-between p-3 rounded-lg
        {% if item.uploaded %}bg-green-50/60 border border-green-200
        {% else %}bg-amber-50/60 border border-amber-200{% endif %}">
        <div class="flex items-center gap-3">
          <span class="material-symbols-outlined text-[20px] {% if item.uploaded %}text-green-600{% else %}text-amber-500{% endif %}">
            {% if item.uploaded %}check_circle{% else %}radio_button_unchecked{% endif %}
          </span>
          <div>
            <p class="text-sm font-semibold" style="color:var(--text)">{{ item.document_type }}</p>
            {% if item.uploaded %}
            <p class="text-xs text-slate-500">
              Uploaded {{ item.uploaded_at|timesince }} ago
              {% if item.verified %}&nbsp;&bull;&nbsp;<span class="text-green-600 font-medium">Verified</span>{% endif %}
            </p>
            {% else %}
            <p class="text-xs text-amber-600 font-medium">Not yet uploaded</p>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-sm text-slate-500 mb-4">No specific documents required by rules. You may still upload supporting documents.</p>
    {% endif %}

    <!-- Upload form -->
    {% if can_upload %}
    <div class="border-t border-primary/10 pt-5">
      <h3 class="font-semibold text-sm mb-4" style="color:var(--text)">
        <span class="material-symbols-outlined text-[16px] text-primary align-middle">upload_file</span>
        Upload a Document
      </h3>
      <form method="post" enctype="multipart/form-data" class="space-y-4">
        {% csrf_token %}
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="form-field">
            <label for="{{ form.document_type.id_for_label }}">Document Type</label>
            {{ form.document_type }}
            {% for e in form.document_type.errors %}<span class="form-error">{{ e }}</span>{% endfor %}
          </div>
          <div class="form-field">
            <label for="{{ form.file.id_for_label }}">File</label>
            {{ form.file }}
            <span class="text-xs text-slate-400">PDF, JPG, PNG — max 5 MB</span>
            {% for e in form.file.errors %}<span class="form-error">{{ e }}</span>{% endfor %}
          </div>
        </div>
        <button type="submit" class="btn-primary">
          <span class="material-symbols-outlined text-[18px]">upload</span>
          Upload Document
        </button>
      </form>
    </div>
    {% else %}
    <p class="text-sm text-slate-500 italic mt-4">Documents cannot be changed at this stage of review.</p>
    {% endif %}
  </div>

</div>
{% endblock %}
